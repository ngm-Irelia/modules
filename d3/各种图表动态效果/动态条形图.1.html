<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>使用g</title>
    <script type="text/javascript" src="./js/d3.v3.min.js"></script>
    <style type="text/css">
        /*(1)鼠标悬停时变色*/
        rect:hover {
            fill: red;
        }

        /*(2)过渡效果*/
        rect {
            -moz-transiton: all 0.3s;
            -o-transiton: all 0.3s;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
    </style>
</head>

<body>
    <button>单击更新</button>
    <br>
    <p id="remove">单击删除</p>
    <p id="add">单击添加</p>
    <br>
    <script type="text/javascript">
        //键值对数据集
        var dataset = [
            { key: 0, value: 715 ,name:"Chrome"},
            { key: 1, value: 560 ,name:"360"},
            { key: 2, value: 422 ,name:"Opera"},
            { key: 3, value: 418 ,name:"Firefox"},
            { key: 4, value: 315 ,name:"IE"},
            { key: 5, value: 313 ,name:"Safari"},
            { key: 6, value: 211 ,name:"MAXTHON"},
            { key: 7, value: 112 ,name:"Netscape"}];

        //设置SVG的高宽
        var w = 1100;
        var h = 600;
        var barPadding = 1;
        //定义序数比例尺
        var yScale = d3.scale.ordinal()//序数比例尺
            .domain(d3.range(dataset.length))
            .rangeRoundBands([0, h], 0.05);
                    
        var xScale = d3.scale.linear()//y仍然是线性比例尺
            .domain([0, d3.max(dataset, function (d) {
                return d.value;
            })])
            .range([0, h]);
        
        var key = function (d) {
            return d.key;
        };
        //值函数 
        var value = function (d) {
            return d.value;
        };
        //条排序函数
        var sortOrders = false;
        var sortBars = function () {
            sortOrders = !sortOrders;//(3)每点击一次排序方向改变
            svg.selectAll("g")
                .sort(function (a, b) {
                    if (sortOrders) {
                        //对数据集升序排序
                        return d3.descending(a.value, b.value);
                        //return d3.ascending(a.value, b.value);//这个地方注意是键值对所以要加上值的引用b.value
                    } else {
                        //对数据集降序排序
                        return d3.descending(a.value, b.value);
                    }

                })
                .transition()
                .duration(1000)
				.attr("transform", function (d, i) {
                  return "translate(" + 10 + "," + (i * 80) + ")";
                });
        };

        //Create SVG element
        var svg = d3.select("body")//选中DOM中的目标元素
            .append("svg")//为目标元素附加上一个svg子元素
            .attr("width", w)//设置这个svg的宽
            .attr("height", h);//设置这个svg的高


		//添加g
		let bar = svg.selectAll("g")
		  .data(dataset)
		  .enter().append("g")
		  .attr("transform", function (d, i) {
			  console.log(d)
		    return "translate(" + 10 + "," + (i * 80) + ")";
		  });

		

        //为SVG添加条形
        bar.append("rect")//选中空元素，表示即将创建这样的元素
            .attr("x", function (d) {//设置纵坐标，纵坐标正方向是从上往下的，所以条有多长就要设置起点是相对于h再向上移动条长
                return 150;//console.log(-(h - xScale(d.value)-200))
            })
            /* .attr("y", function (d, i) {
                return yScale(i);//这里使用序数比例尺，自己去找刚才划分好的档位
            }) */
            .attr("width", function (d) {
                return xScale(d.value);
            })
            .attr("height", yScale.rangeBand())
            .attr("fill", function (d) {//设置RGB颜色与数值的关系
                return "rgb(0, 0, " + (d.value * 10) + ")";
            })
            .on("click", function () {//点击排序
                sortBars();
            });

		// name 
		bar.append("text")
            .text(function (d) {
                return d.name;
            })
			.attr('class', 'name-text')
            .attr("text-anchor", "middle")
            .attr("x", function (d, i) {
                return 50;
            })
            .attr("y", function (d,i) {
				return 35;
                //return yScale(i) + yScale.rangeBand() / 2;
            }) 
            .attr("font-family", "sans-serif")
			.attr("text-align", "right")
            .attr("font-size", function (d) {
                return '20px';
            })
            .attr("fill", "black");
			
        //为条加上数值
        bar.append("text")
            .text(function (d) {
                return d.value;
            })
			.attr('class', 'size-text')
            .attr("text-anchor", "middle")
            .attr("x", function (d, i) {
                return xScale(d.value)+190;
            })
            /* .attr("y", function (d,i) {
                return yScale(i) + yScale.rangeBand() / 2 +15;
            }) */
            .attr("font-family", "sans-serif")
            .attr("font-size", function (d) {
                return yScale.rangeBand() / 2;
            })
            .attr("fill", "red");
 
        // 更新条形数长短的代码,需要一个button标签配合
        //特别注意：这里选中的元素必须在d3选择器之前，或许要先加载完了元素才能被选中
       
        function animalRun(){
            // 更新比例尺，免使纵坐标超出范围
            xScale.domain([0, d3.max(dataset, value)]);//只要更新定义域就行了，映射到的值域不变
                //更新所有的矩形
                svg.selectAll("rect")
                    .transition()// 加上过渡动画 
                    .duration(2000)// 加上动画的持续时间，以毫秒计算
                    /* .attr("y", function (d, i) {
                        return yScale(i);//这里使用序数比例尺，自己去找刚才划分好的档位
                    }) */
					.attr("width", function (d) {
					    return xScale(d.value);
					})
					.attr("height", yScale.rangeBand())
					.attr("fill", function (d) {//设置RGB颜色与数值的关系
					    return "rgb(0, 0, " + (d.value * 10) + ")";
					});
					
					
                // 更新条上的数值
                svg.selectAll(".size-text")
                    .data(dataset, key)
                    .transition()// 加上过渡动画 
                    .delay(function (d, i) {
                        return i / dataset.length * 1000;
                    })
                    .duration(2000)
                    .text(function (d) {
                        return d.value;
                    })
                    .attr("text-anchor", "middle")
                    .attr("x", function (d, i) {
                        return xScale(d.value)+190;
                    })
                    .attr("y", function (d,i) {
						return 50;
                        //return yScale(i) + yScale.rangeBand() / 2 +15;
                    })
        }


        dataset[6].value = 855;
        dataset[4].value = 755;

        animalRun();
        /* setInterval(function(){
            dataset[10].value++;
            dataset[8].value++;
            animalRun()
        },1150) */

    </script>
</body>

</html>