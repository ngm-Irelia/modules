<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>testD3-18-update.html</title>
    <script type="text/javascript" src="./js/d3.v3.min.js"></script>
    <style type="text/css">
        /*(1)鼠标悬停时变色*/
        rect:hover {
            fill: red;
        }

        /*(2)过渡效果*/
        rect {
            -moz-transiton: all 0.3s;
            -o-transiton: all 0.3s;
            -webkit-transition: all 0.3s;
            transition: all 0.3s;
        }
    </style>
</head>

<body>
    <button>单击更新</button>
    <br>
    <p id="remove">单击删除</p>
    <p id="add">单击添加</p>
    <br>
    <script type="text/javascript">
        //键值对数据集
        var dataset = [
            { key: 0, value: 915 },
            { key: 1, value: 910 },
            { key: 2, value: 813 },
            { key: 3, value: 719 },
            { key: 4, value: 621 },
            { key: 5, value: 525 },
            { key: 6, value: 522 },
            { key: 7, value: 518 },
            { key: 8, value: 515 },
            { key: 9, value: 513 },
            { key: 10, value: 511 },
            { key: 11, value: 412 },
            { key: 12, value: 315 },
            { key: 13, value: 220 },
            { key: 14, value: 218 },
            { key: 15, value: 217 },
            { key: 16, value: 216 },
            { key: 17, value: 118 },
            { key: 18, value: 23 },
            { key: 19, value: 5 }];

        //设置SVG的高宽
        var w = 600;
        var h = 600;
        var barPadding = 1;
        //定义序数比例尺
        var yScale = d3.scale.ordinal()//序数比例尺
            .domain(d3.range(dataset.length))
            .rangeRoundBands([0, h], 0.05);
                    
        var xScale = d3.scale.linear()//y仍然是线性比例尺
            .domain([0, d3.max(dataset, function (d) {
                return d.value;
            })])
            .range([0, h]);
        
        var key = function (d) {
            return d.key;
        };
        //值函数 
        var value = function (d) {
            return d.value;
        };
        //条排序函数
        var sortOrders = false;
        var sortBars = function () {
            sortOrders = !sortOrders;//(3)每点击一次排序方向改变
            svg.selectAll("rect")
                .sort(function (a, b) {
                    if (sortOrders) {
                        //对数据集升序排序
                        return d3.descending(a.value, b.value);
                        //return d3.ascending(a.value, b.value);//这个地方注意是键值对所以要加上值的引用b.value
                    } else {
                        //对数据集降序排序
                        return d3.descending(a.value, b.value);
                    }

                })
                .transition()
                .duration(1000)
                .attr("y", function (d, i) {//对排序之后的横坐标重排
                    return yScale(i);
                });

            svg.selectAll("text")
                .sort(function (a, b) {
                    if (sortOrders) {
                        //对数据集升序排序
                        return d3.descending(a.value, b.value);
                        //return d3.ascending(a.value, b.value);//这个地方注意是键值对所以要加上值的引用b.value
                    } else {
                        //对数据集降序排序 
                        return d3.descending(a.value, b.value);
                    }

                })
                .transition()
                .duration(2000)
                .attr("y", function (d, i) {//对排序之后的横坐标重排
                    return yScale(i);
                });
        };

        //Create SVG element
        var svg = d3.select("body")//选中DOM中的目标元素
            .append("svg")//为目标元素附加上一个svg子元素
            .attr("width", w)//设置这个svg的宽
            .attr("height", h);//设置这个svg的高

        //为SVG添加条形
        svg.selectAll("rect")//选中空元素，表示即将创建这样的元素
            .data(dataset, key)//对此后的方法都执行dataset.length遍
            .enter()//数据元素值比前面选中的DOM元素多就创建一个新的DOM元素
            .append("rect")//取得enter的占位元素，并把rect追加到对应的DOM中
            .attr("x", function (d) {//设置纵坐标，纵坐标正方向是从上往下的，所以条有多长就要设置起点是相对于h再向上移动条长
                return 20;//console.log(-(h - xScale(d.value)-200))
            })
            .attr("y", function (d, i) {
                return yScale(i);//这里使用序数比例尺，自己去找刚才划分好的档位
            })
            .attr("width", function (d) {
                return xScale(d.value);
            })
            .attr("height", yScale.rangeBand())
            .attr("fill", function (d) {//设置RGB颜色与数值的关系
                return "rgb(0, 0, " + (d.value * 10) + ")";
            })
            .on("click", function () {//点击排序
                sortBars();
            });

        //为条加上数值
        svg.selectAll("text")
            .data(dataset, key)
            .enter()
            .append("text")
            .text(function (d) {
                return d.value;
            })
            .attr("text-anchor", "middle")
            .attr("x", function (d, i) {
                //console.log(h - xScale(d.value) + 14)
                return xScale(d.value);
            })
            .attr("y", function (d,i) {
                return yScale(i) + yScale.rangeBand() / 2;
            })
            .attr("font-family", "sans-serif")
            .attr("font-size", function (d) {
                return yScale.rangeBand() / 2;
            })
            .attr("fill", "red");
 
        // 更新条形数长短的代码,需要一个button标签配合
        //特别注意：这里选中的元素必须在d3选择器之前，或许要先加载完了元素才能被选中
       
        function animalRun(){
            // 更新比例尺，免使纵坐标超出范围
            xScale.domain([0, d3.max(dataset, value)]);//只要更新定义域就行了，映射到的值域不变
                //更新所有的矩形
                svg.selectAll("rect")
                    .data(dataset, key)
                    .transition()// 加上过渡动画 
                    .delay(function (d) {
                        return 1000;
                    })//指定过度什么时间开始，可以用函数控制每一条的动画时间，这样就可得到钢琴版的效果
                    .duration(2000)// 加上动画的持续时间，以毫秒计算
                    .attr("x", function (d) {//设置纵坐标，纵坐标正方向是从上往下的，所以条有多长就要设置起点是相对于h再向上移动条长
                        return 20;//console.log(-(h - xScale(d.value)-200))
                    })
                    .attr("y", function (d, i) {
                        return yScale(i);//这里使用序数比例尺，自己去找刚才划分好的档位
                    })
                    .attr("height", function (d) {
                        return yScale.rangeBand();
                    });

                // 更新条上的数值
                svg.selectAll("text")
                    .data(dataset, key)
                    .transition()// 加上过渡动画 
                    .delay(function (d) {
                        return 1000;
                    })
                    .duration(2000)
                    .text(function (d) {
                        return d.value;
                    })
                    .attr("text-anchor", "middle")
                    .attr("x", function (d, i) {
                        return xScale(d.value);
                    })
                    .attr("y", function (d,i) {
                        return yScale(i) + yScale.rangeBand() / 2;
                    })
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "12px")
                    .attr("fill", "red");
        }


        dataset[10].value = 555;
        dataset[8].value = 655;

        animalRun();
        /* setInterval(function(){
            dataset[10].value++;
            dataset[8].value++;
            animalRun()
        },1150) */

    </script>
</body>

</html>